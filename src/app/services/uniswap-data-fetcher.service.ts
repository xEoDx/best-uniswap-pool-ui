import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Pool } from '../models/pool';
import { PoolVolumeInterval } from "../models/pool-volume-interval";
import { Token } from '../models/token';
import { Blockchain } from '../models/blockchain';
import { environment } from '../../environments/environment';

@Injectable({
  providedIn: 'root'
})
export class UniswapDataFetcherService {
  private _pools: Array<Pool>;

  constructor(private http: HttpClient) { 
    this._pools = new Array<Pool>();
  }

  public getAll() : Promise<Array<Pool>> {
  
    if(this._pools === null || this._pools.length === 0){
      if(environment.isLocalEnv) {
        this.getDummyData().pools.forEach((p:any) => {
            this.addPool(p);
        });
        return new Promise<Array<Pool>>(resolve => {resolve(this._pools)});

      } else {
        return new Promise<Array<Pool>>((resolve, reject) => {
          const url = environment.apiEndpoint + '/pools';
          this.http.get(url).subscribe({
            next: (res: any) => {

            res.pools.forEach((p:any) => {
              this.addPool(p);
            });
            resolve(this._pools);
            },
            error: (err: any) => {
              reject(err);
            },
            complete: () => {
            },
          
          });
        });
      }
        
    } else{
      return new Promise<Array<Pool>>(resolve => {resolve(this._pools)});
    }    
  }

  private addPool(p:any): void{

    if(p === null || p?._dayData === undefined){
      return;
    }

    const poolVolumes: Array<PoolVolumeInterval> = new Array<PoolVolumeInterval>();
    const parsedVolumes: Array<{_tvl:number, _volume: number, _interval: number }> = (p._dayData);
    parsedVolumes.forEach(v => {
      let poolIntervalData = new PoolVolumeInterval(+v._volume, +v._tvl, v._interval);
      poolVolumes.push(poolIntervalData);
    });

    let token0: Token = new Token(p._token0._name);
    let token1: Token = new Token(p._token1._name);

    let pool: Pool = new Pool(p._id, p._blockchain, p._feeTier, poolVolumes, token0, token1);
    this._pools.push(pool);
  }

  private getDummyData(): any{
    console.log("DUMMY DATA!");
    return {"pools":[{"_id":"0x88e6a0c2ddd26feeb64f039a2c41296fcb3f5640","_blockchain":"Ethereum","_feeTier":"500","_token0":{"_name":"USDC","_prices":[]},"_token1":{"_name":"WETH","_prices":[]},"_dayData":[{"_tvl":"280599788.8822295808352578173368592","_volume":"82306603.65478524446913758688193151","_interval":0},{"_tvl":"284255791.182582447964287792749405","_volume":"628498016.625746307639159866028187","_interval":1},{"_tvl":"269465908.155385939367876596756102","_volume":"651872552.5983909837269427011586646","_interval":2},{"_tvl":"282956184.4304967941482065929124886","_volume":"587779997.8377599845976124565440956","_interval":3},{"_tvl":"283548721.0920773671696677732019098","_volume":"686262569.5141987864901181868879945","_interval":4},{"_tvl":"267598512.3735572277185622227883035","_volume":"292940336.8745666168851873193547265","_interval":5},{"_tvl":"264740619.2479814628245502377938168","_volume":"561034881.7307502994752166496711162","_interval":6},{"_tvl":"249835367.1424924373722466915502785","_volume":"904399821.9588574756985989150996057","_interval":7},{"_tvl":"254265002.6853635079517631225135296","_volume":"1190397424.353643875493742355624822","_interval":8},{"_tvl":"299032275.3260183917880611852871272","_volume":"659154054.9497544165760331781213719","_interval":9},{"_tvl":"303409789.1839080595170032536377537","_volume":"487638223.903071999454526364832771","_interval":10},{"_tvl":"302053680.0865589006266179725119387","_volume":"714041350.804656371546134040545588","_interval":11},{"_tvl":"278586952.4437724385356520378056235","_volume":"367406563.3635927326934469014466005","_interval":12},{"_tvl":"273777688.1036213890412744996621592","_volume":"304065925.5699860418817497898272834","_interval":13},{"_tvl":"268675647.9374705329686244422822418","_volume":"681778593.8091735266227768242226464","_interval":14},{"_tvl":"257577201.177233131247815349431261","_volume":"807599748.9060564403864095612770077","_interval":15},{"_tvl":"243250603.2155597691813490450071028","_volume":"735942184.5407446207107640165302621","_interval":16},{"_tvl":"248618458.7385668533215484278034206","_volume":"492925062.0385249112681863051602733","_interval":17},{"_tvl":"238605522.542790209772138093862271","_volume":"933912329.6058375989670029614709409","_interval":18},{"_tvl":"241983276.5531918608902392079992392","_volume":"459642241.5847393073038875013459919","_interval":19},{"_tvl":"231097678.0968609377518932801518108","_volume":"601549551.447370947381380324485703","_interval":20},{"_tvl":"218088232.969585329975059873521243","_volume":"1008967466.295865705707764100688437","_interval":21},{"_tvl":"205047330.7507636682220358480573512","_volume":"1801962736.716712217172928164396455","_interval":22},{"_tvl":"219353084.2295032659802314931306793","_volume":"1933541490.805420795564444682141927","_interval":23},{"_tvl":"237058750.9011385844268839190240052","_volume":"1399373114.010079108883243882791024","_interval":24},{"_tvl":"229854534.8799001568246884538634949","_volume":"1429476509.576669084382732418163472","_interval":25},{"_tvl":"288329324.1184551315844386427291044","_volume":"839861841.3308430743691970476603419","_interval":26},{"_tvl":"299177554.0810152408238957464164351","_volume":"485178688.7604625843723263838719386","_interval":27},{"_tvl":"306706164.7193033204865769831385978","_volume":"1053082036.82606766570886317922292","_interval":28},{"_tvl":"295476954.4124157098949405325058479","_volume":"940318238.58575228544038006632713","_interval":29},{"_tvl":"319478444.2382858969208370430310605","_volume":"874790785.9398196369307320012640982","_interval":30}]},{"_id":"0x8ad599c3a0ff1de082011efddc58f1908eb6e6d8","_blockchain":"Ethereum","_feeTier":"3000","_token0":{"_name":"USDC","_prices":[]},"_token1":{"_name":"WETH","_prices":[]},"_dayData":[{"_tvl":"316365087.780197676697351103216669","_volume":"5606826.429393058501184827653211056","_interval":0},{"_tvl":"319022923.2080957732001575100706871","_volume":"50192714.34220480498666896822943479","_interval":1},{"_tvl":"313660145.8257714233050062310065128","_volume":"62408905.27085463790806513088395863","_interval":2},{"_tvl":"327515206.0757365641191837106634326","_volume":"62671050.9466614319941020506754166","_interval":3},{"_tvl":"330945603.8115938831870467659388513","_volume":"91377862.73642326051897232080055278","_interval":4},{"_tvl":"318473214.1395355054089894521251544","_volume":"20763798.55840664612741169112153777","_interval":5},{"_tvl":"316399962.481441482581848653555988","_volume":"46090554.87906407915389154307182787","_interval":6},{"_tvl":"306772473.0714534220548525180952436","_volume":"99887012.16428937211887375367048133","_interval":7},{"_tvl":"312487446.6571490224361299352348995","_volume":"174503830.6011446121837732051901581","_interval":8},{"_tvl":"346673850.3325390033570144281029453","_volume":"70858551.28321212792553582880811952","_interval":9},{"_tvl":"347386641.3555569324136929136940559","_volume":"61411881.28623481476227804905070627","_interval":10},{"_tvl":"348255067.2373981368210543927137737","_volume":"92646718.15149800525159008275929652","_interval":11},{"_tvl":"357621666.6982035723019880759732676","_volume":"47300790.05318949312728717559790592","_interval":12},{"_tvl":"348172737.7527231673641248423276054","_volume":"31656920.68646072771873967342605901","_interval":13},{"_tvl":"347876892.0787132200872901384471656","_volume":"89723667.60633531901317924007457364","_interval":14},{"_tvl":"350017220.7687272095885780969017161","_volume":"110726037.4247697892519884444526801","_interval":15},{"_tvl":"338790017.7778814151222290329182983","_volume":"90571316.69205324376181270777787565","_interval":16},{"_tvl":"358806431.8345715427631661016979497","_volume":"86139817.48234437460713792953004678","_interval":17},{"_tvl":"337504757.0426024382563001115017341","_volume":"155650617.3496602088876616798670897","_interval":18},{"_tvl":"343936287.0955910372863398024746732","_volume":"73864029.0663830631652121570158134","_interval":19},{"_tvl":"333435230.0421760556279257587842019","_volume":"105834931.7656424811572273502164254","_interval":20},{"_tvl":"325683582.3130467681559160534134901","_volume":"205933617.6163940474344672104482279","_interval":21},{"_tvl":"304121430.6745059818488788156712308","_volume":"415594193.9740855056529747700426771","_interval":22},{"_tvl":"329808013.7884359636729031348642715","_volume":"542940542.3895737513665955062973277","_interval":23},{"_tvl":"351738935.4368256657958969256911661","_volume":"236279147.3150939306727878711903029","_interval":24},{"_tvl":"341972316.8975326527405760286460591","_volume":"268002029.590619069980614748862655","_interval":25},{"_tvl":"395940541.6904005953210783067979409","_volume":"101294930.3172687602739610381141835","_interval":26},{"_tvl":"413762048.2888429328764430053826737","_volume":"46600917.52245367162388430841798244","_interval":27},{"_tvl":"408246941.2553262236135714013757798","_volume":"137782311.9931823354346704145452319","_interval":28},{"_tvl":"389170079.1751385486258328934195545","_volume":"59213401.75855698255063396031232094","_interval":29},{"_tvl":"406108300.6699528233843429267794382","_volume":"57559232.8475681505972109087061898","_interval":30}]},{"_id":"0x11b815efb8f581194ae79006d24e0d814b7697f6","_blockchain":"Ethereum","_feeTier":"500","_token0":{"_name":"WETH","_prices":[]},"_token1":{"_name":"USDT","_prices":[]},"_dayData":[{"_tvl":"28530398.5786338183541818024979455","_volume":"2491139.028084665238286835188098231","_interval":0},{"_tvl":"28736903.41533428234450407727799924","_volume":"34737275.59543935075994935467410691","_interval":1},{"_tvl":"28571695.17331118781094721741161712","_volume":"40589054.83813038433910471176988406","_interval":2},{"_tvl":"25823086.38504161718573583245487646","_volume":"31279900.80406282947172796696010228","_interval":3},{"_tvl":"26183322.2078368052476053888014755","_volume":"31204870.03612146228223624438396913","_interval":4},{"_tvl":"24854293.09974164688376924914765533","_volume":"12539894.53120259042759159150522627","_interval":5},{"_tvl":"24413908.36194816478000011919012325","_volume":"12767836.60305169115956416864316739","_interval":6},{"_tvl":"23840126.31253149097579795693848808","_volume":"21910914.08119651037912692473188554","_interval":7},{"_tvl":"24386273.64665406832261881056139632","_volume":"37181845.1358104295868777183567579","_interval":8},{"_tvl":"28933068.92740913153062414243516191","_volume":"29281421.50912348443285569328501715","_interval":9},{"_tvl":"29103621.80101103690215988004619974","_volume":"45241894.54541507154340698028612776","_interval":10},{"_tvl":"29010105.89755573862638613535641309","_volume":"36901758.52208294569566317386618858","_interval":11},{"_tvl":"29411862.37712908229311621587417667","_volume":"25728631.02788639115824750066648073","_interval":12},{"_tvl":"28733990.64961260166972962133384073","_volume":"10707589.65150381715107515936818063","_interval":13},{"_tvl":"28612834.00174583354669112738513424","_volume":"35335240.56426659755042172206549705","_interval":14},{"_tvl":"29321340.39130641532690024457616806","_volume":"48803653.87361957299408431197416337","_interval":15},{"_tvl":"28437365.64504772319692256452760508","_volume":"59586676.96296018858502283608417346","_interval":16},{"_tvl":"30160096.38651395069938196534408611","_volume":"56608918.01761261862694266447608586","_interval":17},{"_tvl":"31567508.58261549073382231480337575","_volume":"54646417.18492753706122157960760916","_interval":18},{"_tvl":"30634165.88261950343917805824787611","_volume":"40300643.7518138398544819317640664","_interval":19},{"_tvl":"29849198.40092893885020864180943395","_volume":"65906255.74970697731577017621999036","_interval":20},{"_tvl":"29317301.13644462556560974859655704","_volume":"104753381.2125282413954090384270553","_interval":21},{"_tvl":"28992854.7429690099195532237370599","_volume":"121896188.091916724035903197654618","_interval":22},{"_tvl":"30853370.87065285359987976342952035","_volume":"119369208.1969845221678033473768505","_interval":23},{"_tvl":"33363390.83440885068392432250730066","_volume":"119086007.9326280661864588672747216","_interval":24},{"_tvl":"32331050.49067396949789014934886251","_volume":"133416354.0725319189982172487690807","_interval":25},{"_tvl":"46503728.09996456239892482575354702","_volume":"194721863.6199347422238018968122387","_interval":26},{"_tvl":"57592064.28556346219828687765350211","_volume":"79495460.50374926478348790684984818","_interval":27},{"_tvl":"58187303.00235446308949719800326079","_volume":"95090295.79849806291548379186318529","_interval":28},{"_tvl":"49251667.36465465923752264500844794","_volume":"93360712.89648365232808496440755951","_interval":29},{"_tvl":"51592867.41740897577171907956661839","_volume":"63412942.23079574182636518439825943","_interval":30}]}]};
  }
}
